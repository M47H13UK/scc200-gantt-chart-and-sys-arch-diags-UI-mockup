<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1200">
  <title>SCC.200 Group 6-6 &ndash; System Architecture Diagrams</title>
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #F8FAFC;
      color: #1E293B;
      padding: 32px 40px 60px;
      min-width: 1100px;
    }

    /* ===== HEADER ===== */
    .page-header { text-align: center; margin-bottom: 36px; }
    .page-header h1 {
      font-size: 1.75rem; font-weight: 700; color: #0F172A; letter-spacing: -0.02em;
    }
    .page-header .subtitle {
      font-size: 0.95rem; color: #64748B; margin-top: 4px;
    }

    /* ===== SECTION TITLE ===== */
    .section-title {
      font-size: 1.25rem; font-weight: 700; color: #0F172A;
      margin: 40px 0 12px; padding-bottom: 8px;
      border-bottom: 2px solid #E2E8F0;
      text-align: center;
    }
    .section-title:first-of-type { margin-top: 0; }

    /* ===== DIAGRAM CONTAINER ===== */
    .diagram-container {
      background: #FFFFFF;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      padding: 24px;
      overflow-x: auto;
      margin-bottom: 8px;
      display: flex;
      justify-content: center;
    }
    .diagram-container svg text {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    /* ===== CAPTION ===== */
    .caption {
      font-size: 0.85rem;
      color: #64748B;
      margin: 0 auto 24px;
      max-width: 980px;
      line-height: 1.5;
      text-align: center;
    }

    /* ===== LEGEND ===== */
    .legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 0 auto 16px;
      padding: 10px 18px;
      background: #FFFFFF;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      font-size: 0.82rem;
      color: #475569;
    }
    .legend-item { display: flex; align-items: center; gap: 7px; }
    .legend-swatch {
      width: 28px; height: 14px; border-radius: 3px; flex-shrink: 0;
    }

    /* ===== TOOLTIP ===== */
    .tooltip {
      display: none;
      position: fixed;
      background: #0F172A;
      color: #F8FAFC;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.8rem;
      line-height: 1.55;
      z-index: 100;
      pointer-events: none;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      max-width: 360px;
    }
    .tooltip.visible { display: block; }
    .tooltip strong { color: #FCD34D; }
  </style>
</head>
<body>

<div class="page-header">
  <h1>System Architecture Diagrams</h1>
  <p class="subtitle">SCC.200 Group 6-6 &mdash; Regional Transport Hub &mdash; Coursework App Architecture</p>
</div>

<!-- ===== DIAGRAM 1 ===== -->
<div class="section-title">Diagram 1: System Context and Trust Boundaries</div>
<div class="legend">
  <div class="legend-item"><div class="legend-swatch" style="background:#DBEAFE;border:1.5px solid #3B82F6;"></div> Browser / Frontend</div>
  <div class="legend-item"><div class="legend-swatch" style="background:#D1FAE5;border:1.5px solid #10B981;"></div> Backend Integration Layer</div>
  <div class="legend-item"><div class="legend-swatch" style="background:#FEF3C7;border:1.5px solid #F59E0B;"></div> External Dependency</div>
  <div class="legend-item"><div class="legend-swatch" style="background:none;border:2px dashed #3B82F6;"></div> Team Controlled Boundary</div>
  <div class="legend-item"><div class="legend-swatch" style="background:none;border:2px dashed #F59E0B;"></div> External Boundary</div>
</div>
<div class="diagram-container"><svg id="d1"></svg></div>
<p class="caption">Hover over any component or module to view details. The team-controlled boundary encompasses the browser PWA and the Node.js integration layer; all external data originates from the university transport endpoint.</p>

<!-- ===== DIAGRAM 2 ===== -->
<div class="section-title">Diagram 2: Deployment Scope (Coursework App vs Production Estimate)</div>
<div class="diagram-container"><svg id="d2"></svg></div>
<p class="caption">The coursework app uses a simple two-tier deployment via the university network. The production estimate shows a horizontally scalable architecture with CDN, load balancer, and managed database. Components shown are representative, not an exhaustive deployment inventory.</p>

<!-- ===== DIAGRAM 3 ===== -->
<div class="section-title">Diagram 3: Layered Module View (Coursework App)</div>
<div class="diagram-container"><svg id="d3"></svg></div>
<p class="caption">Hover over any module to see its responsibilities. In the coursework app, both the browser frontend and the Node.js backend run on the same local device. Only the university transport endpoint is external, accessed via HTTPS and STOMP. Module cards show named architecture modules, not a file-by-file inventory.</p>

<!-- ===== DIAGRAM 4 ===== -->
<div class="section-title">Diagram 4: Data Flow Sequence (Example Search Request)</div>
<div class="diagram-container"><svg id="d4"></svg></div>
<p class="caption">Hover over each step to see details. This sequence illustrates the cache-first strategy: the backend checks its in-memory cache before fetching from the university endpoint.</p>

<!-- ===== DIAGRAM 5 ===== -->
<div class="section-title">Diagram 5: Data Normalization and Filtering Pipeline</div>
<div class="diagram-container"><svg id="d5"></svg></div>
<p class="caption">Every external payload passes through this pipeline before reaching the frontend. Malformed records are rejected and logged at the validation stage.</p>

<!-- ===== TOOLTIP ===== -->
<div class="tooltip" id="tooltip"></div>

<script>
(function() {
  'use strict';

  // ===== SVG HELPERS =====
  const NS = 'http://www.w3.org/2000/svg';

  function $(id) { return document.getElementById(id); }

  function s(tag, attrs) {
    const el = document.createElementNS(NS, tag);
    if (attrs) Object.entries(attrs).forEach(([k, v]) => {
      if (v !== undefined && v !== null) el.setAttribute(k, String(v));
    });
    return el;
  }

  function addDefs(svg) {
    const defs = s('defs');
    // Gray arrowhead
    const m1 = s('marker', { id: 'ag', markerWidth: 10, markerHeight: 8, refX: 10, refY: 4, orient: 'auto' });
    m1.appendChild(s('path', { d: 'M0 0 L10 4 L0 8z', fill: '#64748B' }));
    defs.appendChild(m1);
    // Blue arrowhead
    const m2 = s('marker', { id: 'ab', markerWidth: 10, markerHeight: 8, refX: 10, refY: 4, orient: 'auto' });
    m2.appendChild(s('path', { d: 'M0 0 L10 4 L0 8z', fill: '#3B82F6' }));
    defs.appendChild(m2);
    // Green arrowhead
    const m3 = s('marker', { id: 'ae', markerWidth: 10, markerHeight: 8, refX: 10, refY: 4, orient: 'auto' });
    m3.appendChild(s('path', { d: 'M0 0 L10 4 L0 8z', fill: '#10B981' }));
    defs.appendChild(m3);
    // Amber arrowhead
    const m4 = s('marker', { id: 'aa', markerWidth: 10, markerHeight: 8, refX: 10, refY: 4, orient: 'auto' });
    m4.appendChild(s('path', { d: 'M0 0 L10 4 L0 8z', fill: '#F59E0B' }));
    defs.appendChild(m4);
    // Red arrowhead
    const m5 = s('marker', { id: 'ar', markerWidth: 10, markerHeight: 8, refX: 10, refY: 4, orient: 'auto' });
    m5.appendChild(s('path', { d: 'M0 0 L10 4 L0 8z', fill: '#EF4444' }));
    defs.appendChild(m5);
    // Small gray arrowhead (for pipeline)
    const m7 = s('marker', { id: 'ags', markerWidth: 7, markerHeight: 6, refX: 7, refY: 3, orient: 'auto' });
    m7.appendChild(s('path', { d: 'M0 0 L7 3 L0 6z', fill: '#64748B' }));
    defs.appendChild(m7);
    // Slate arrowhead (for sequence)
    const m6 = s('marker', { id: 'as', markerWidth: 8, markerHeight: 6, refX: 8, refY: 3, orient: 'auto' });
    m6.appendChild(s('path', { d: 'M0 0 L8 3 L0 6z', fill: '#475569' }));
    defs.appendChild(m6);
    // Drop shadow filter
    const f = s('filter', { id: 'ds', x: '-5%', y: '-5%', width: '110%', height: '120%' });
    const shadow = s('feDropShadow', { dx: 0, dy: 2, stdDeviation: 3, 'flood-color': 'rgba(0,0,0,0.12)' });
    f.appendChild(shadow);
    defs.appendChild(f);
    svg.appendChild(defs);
  }

  // Tooltip
  const tip = $('tooltip');
  function showTip(e, html) {
    tip.innerHTML = html;
    tip.classList.add('visible');
    moveTip(e);
  }
  function moveTip(e) {
    const pad = 16;
    let x = e.clientX + pad, y = e.clientY + pad;
    const tw = tip.offsetWidth, th = tip.offsetHeight;
    if (x + tw > window.innerWidth - 10) x = e.clientX - tw - pad;
    if (y + th > window.innerHeight - 10) y = e.clientY - th - pad;
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';
  }
  function hideTip() { tip.classList.remove('visible'); }

  // Interactive chip
  function chip(parent, cx, cy, w, h, label, fill, stroke, tipHtml) {
    const g = s('g', { cursor: 'pointer' });
    const r = s('rect', { x: cx - w/2, y: cy - h/2, width: w, height: h, rx: 6, fill: fill, stroke: stroke, 'stroke-width': 1.5 });
    const t = s('text', { x: cx, y: cy + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 11, 'font-weight': 600, fill: '#334155' });
    t.textContent = label;
    g.appendChild(r);
    g.appendChild(t);
    g.addEventListener('mouseenter', e => {
      r.setAttribute('stroke-width', '2.5');
      r.setAttribute('filter', 'url(#ds)');
      showTip(e, tipHtml);
    });
    g.addEventListener('mousemove', moveTip);
    g.addEventListener('mouseleave', () => {
      r.setAttribute('stroke-width', '1.5');
      r.removeAttribute('filter');
      hideTip();
    });
    parent.appendChild(g);
    return g;
  }

  // Protocol badge on arrow
  function badge(parent, cx, cy, label, bg) {
    const g = s('g');
    const w = label.length * 6.8 + 18;
    g.appendChild(s('rect', { x: cx - w/2, y: cy - 11, width: w, height: 22, rx: 11, fill: bg || '#475569' }));
    const t = s('text', { x: cx, y: cy + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10.5, 'font-weight': 700, fill: '#FFFFFF', 'letter-spacing': '0.02em' });
    t.textContent = label;
    g.appendChild(t);
    parent.appendChild(g);
    return g;
  }

  // Zone label
  function zoneLabel(parent, x, y, label, color) {
    const g = s('g');
    const w = label.length * 7.5 + 20;
    g.appendChild(s('rect', { x: x, y: y - 11, width: w, height: 22, rx: 4, fill: color }));
    const t = s('text', { x: x + w/2, y: y + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10.5, 'font-weight': 700, fill: '#FFFFFF', 'letter-spacing': '0.06em' });
    t.textContent = label;
    g.appendChild(t);
    parent.appendChild(g);
  }

  // Section subtitle in SVG
  function sectionText(parent, x, y, label, size, color, weight) {
    const t = s('text', { x: x, y: y, 'font-size': size || 13, 'font-weight': weight || 700, fill: color || '#0F172A' });
    t.textContent = label;
    parent.appendChild(t);
    return t;
  }

  // ================================================================
  // DIAGRAM 1: SYSTEM CONTEXT AND TRUST BOUNDARIES
  // ================================================================
  (function renderDiagram1() {
    const svg = $('d1');
    const W = 1060, H = 800;
    svg.setAttribute('width', W);
    svg.setAttribute('height', H);
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    addDefs(svg);

    const ZX = 30, ZW = W - 60;

    // ---- Team Controlled Zone ----
    svg.appendChild(s('rect', {
      x: ZX, y: 20, width: ZW, height: 455, rx: 14,
      fill: 'rgba(59,130,246,0.03)', stroke: '#3B82F6',
      'stroke-width': 2.5, 'stroke-dasharray': '10,5'
    }));
    zoneLabel(svg, ZX + 14, 36, 'TEAM CONTROLLED', '#3B82F6');

    // Browser box
    const bx = 70, by = 58, bw = ZW - 80, bh = 175;
    svg.appendChild(s('rect', { x: bx, y: by, width: bw, height: bh, rx: 10, fill: '#DBEAFE', stroke: '#3B82F6', 'stroke-width': 1.5 }));
    sectionText(svg, bx + bw/2, by + 24, 'Browser (React PWA)', 14, '#1D4ED8', 700).setAttribute('text-anchor', 'middle');

    // Browser features subtitle
    const ft = s('text', { x: bx + bw/2, y: by + 44, 'text-anchor': 'middle', 'font-size': 10.5, fill: '#64748B' });
    ft.textContent = 'Map, Search, Departures, Journey Planner, Favourites, Weather';
    svg.appendChild(ft);

    const shortEtcTip = 'This is not the full list. This is a shortened version for the diagram.';

    // Frontend module chips (split into two rows for readability)
    const fMods = [
      { label: 'MapModule', tip: '<strong>MapModule</strong><br>Interactive Leaflet map with OpenStreetMap tiles. Displays bus stops, rail stations, and live vehicle positions. Region-restricted to Preston-Lancaster-Blackpool-Fylde-Wyre.' },
      { label: 'SearchModule', tip: '<strong>SearchModule</strong><br>Text search for stops/stations using NaPTAN/NPTG data. Results shown on map with markers and in a selectable list. Returns results within 2 seconds.' },
      { label: 'DeparturesModule', tip: '<strong>DeparturesModule</strong><br>Departure boards showing next 5+ departures with scheduled times, live status (on time/delayed/cancelled), operator, and platform (rail) or route number (bus).' },
      { label: 'JourneyModule', tip: '<strong>JourneyModule</strong><br>Journey planner interface supporting A-to-B and multi-stop routes. Displays step-by-step legs, transfer points, total duration, and alternative routes.' },
      { label: 'FavouritesModule', tip: '<strong>FavouritesModule</strong><br>Save/remove favourite stops using browser localStorage. Data persists across sessions without authentication or server-side storage.' },
      { label: 'WeatherModule', tip: '<strong>WeatherModule</strong><br>Current weather conditions and derived transport-impact advisories from configurable thresholds (high winds, heavy rain, snow). Shown as prominent banner.' },
    ];
    const chipW = 138, chipH = 30, chipGap = 14, moduleEtcW = 52;
    const fRows = [
      [fMods[0], fMods[1], fMods[2]],
      [fMods[3], fMods[4], fMods[5], { label: 'etc.', tip: shortEtcTip, isEtc: true }]
    ];
    const fRowStartY = by + 70, fRowGap = 34;
    fRows.forEach((row, rowIndex) => {
      const rowWidth = row.reduce((acc, item, idx) => {
        const itemWidth = item.isEtc ? moduleEtcW : chipW;
        return acc + itemWidth + (idx < row.length - 1 ? chipGap : 0);
      }, 0);
      let rowX = bx + (bw - rowWidth) / 2;
      const rowY = fRowStartY + rowIndex * fRowGap;
      row.forEach(item => {
        const itemWidth = item.isEtc ? moduleEtcW : chipW;
        chip(svg, rowX + itemWidth / 2, rowY, itemWidth, chipH, item.label, '#EFF6FF', '#93C5FD', item.tip);
        rowX += itemWidth + chipGap;
      });
    });

    // localStorage note
    const lsG = s('g', { cursor: 'pointer' });
    const lsW = 400, lsH = 28;
    lsG.appendChild(s('rect', { x: bx + bw/2 - lsW/2, y: by + 130, width: lsW, height: lsH, rx: 6, fill: '#F8FAFC', stroke: '#CBD5E1', 'stroke-width': 1, 'stroke-dasharray': '4,2' }));
    const lsT = s('text', { x: bx + bw/2, y: by + 144 + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10.5, fill: '#64748B', 'font-style': 'italic' });
    lsT.textContent = 'localStorage: favourites, preferences, recent searches';
    lsG.appendChild(lsT);
    lsG.addEventListener('mouseenter', e => showTip(e, '<strong>Browser localStorage</strong><br>User-specific data stored entirely in the browser. Never transmitted to any server. Cleared when user clears browser data. No authentication required.'));
    lsG.addEventListener('mousemove', moveTip);
    lsG.addEventListener('mouseleave', hideTip);
    svg.appendChild(lsG);

    // HTTPS arrow (browser -> backend)
    const arrowX = bx + bw / 2;
    const arrowY1 = by + bh + 2;
    const arrowY2 = by + bh + 64;
    svg.appendChild(s('line', { x1: arrowX, y1: arrowY1, x2: arrowX, y2: arrowY2, stroke: '#64748B', 'stroke-width': 2, 'marker-end': 'url(#ag)' }));
    badge(svg, arrowX, arrowY1 + (arrowY2 - arrowY1) * 0.38, 'HTTPS', '#475569');

    // Backend box
    const bkx = 70, bky = by + bh + 68, bkw = bw, bkh = 160;
    svg.appendChild(s('rect', { x: bkx, y: bky, width: bkw, height: bkh, rx: 10, fill: '#D1FAE5', stroke: '#10B981', 'stroke-width': 1.5 }));
    sectionText(svg, bkx + bkw/2, bky + 24, 'Node.js / Express Integration Layer', 14, '#047857', 700).setAttribute('text-anchor', 'middle');

    const bkSub = s('text', { x: bkx + bkw/2, y: bky + 44, 'text-anchor': 'middle', 'font-size': 10.5, fill: '#64748B' });
    bkSub.textContent = 'Backend proxy providing a single API surface over multiple data sources';
    svg.appendChild(bkSub);

    // Backend module chips
    const bMods = [
      { label: 'ApiRoutes', tip: '<strong>ApiRoutes</strong><br>Express HTTP handlers with request validation, error formatting, and consistent JSON responses. Single API surface for all frontend requests.' },
      { label: 'DataIngestion', tip: '<strong>DataIngestion</strong><br>Fetches and parses data from university endpoints: NaPTAN XML, bus live XML, bus times JSON (with linked timetable XML), rail departures, and weather JSON.' },
      { label: 'CacheService', tip: '<strong>CacheService</strong><br>In-memory cache using node-cache with TTL expiry.<br>Stops: 24h | Bus positions: 30s<br>Rail departures: 60s | Weather: 5min' },
      { label: 'JourneyEngine', tip: '<strong>JourneyEngine</strong><br>Route calculation using modified Dijkstra with weighted cost for travel time, waiting time, transfer penalty, and hub preference scoring.' },
      { label: 'StompClient', tip: '<strong>StompClient</strong><br>Persistent STOMP connection to transport.scc.lancs.ac.uk:61613. Subscribes to TRAIN_MVT_ALL_TOC, VSTP_ALL, and TD_ALL_SIG_AREA topics for real-time rail data.' },
    ];
    const bRows = [
      [bMods[0], bMods[1], bMods[2]],
      [bMods[3], bMods[4], { label: 'etc.', tip: shortEtcTip, isEtc: true }]
    ];
    const bRowStartY = bky + 70, bRowGap = 34;
    bRows.forEach((row, rowIndex) => {
      const rowWidth = row.reduce((acc, item, idx) => {
        const itemWidth = item.isEtc ? moduleEtcW : chipW;
        return acc + itemWidth + (idx < row.length - 1 ? chipGap : 0);
      }, 0);
      let rowX = bkx + (bkw - rowWidth) / 2;
      const rowY = bRowStartY + rowIndex * bRowGap;
      row.forEach(item => {
        const itemWidth = item.isEtc ? moduleEtcW : chipW;
        chip(svg, rowX + itemWidth / 2, rowY, itemWidth, chipH, item.label, '#ECFDF5', '#6EE7B7', item.tip);
        rowX += itemWidth + chipGap;
      });
    });

    // Backend note
    const bnG = s('g', { cursor: 'pointer' });
    const bnW = 320, bnH = 26;
    bnG.appendChild(s('rect', { x: bkx + bkw/2 - bnW/2, y: bky + 126, width: bnW, height: bnH, rx: 6, fill: '#F0FDF4', stroke: '#BBF7D0', 'stroke-width': 1, 'stroke-dasharray': '4,2' }));
    const bnT = s('text', { x: bkx + bkw/2, y: bky + 139 + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10.5, fill: '#64748B', 'font-style': 'italic' });
    bnT.textContent = 'In-memory TTL cache (no external database)';
    bnG.appendChild(bnT);
    bnG.addEventListener('mouseenter', e => showTip(e, '<strong>In-memory Cache</strong><br>All cached data lives in the Node.js process memory using node-cache. No external database is required for the coursework app. Data is refreshed based on TTL expiry per entity type.'));
    bnG.addEventListener('mousemove', moveTip);
    bnG.addEventListener('mouseleave', hideTip);
    svg.appendChild(bnG);

    // ---- Arrow between zones ----
    const zArrowY1 = 479;
    const zArrowY2 = 555;
    svg.appendChild(s('line', { x1: arrowX, y1: zArrowY1, x2: arrowX, y2: zArrowY2, stroke: '#64748B', 'stroke-width': 2.5, 'marker-end': 'url(#ag)' }));
    badge(svg, arrowX, zArrowY1 + (zArrowY2 - zArrowY1) * 0.38, 'HTTPS + STOMP', '#64748B');

    // ---- External Dependency Zone ----
    svg.appendChild(s('rect', {
      x: ZX, y: 561, width: ZW, height: 215, rx: 14,
      fill: 'rgba(245,158,11,0.04)', stroke: '#F59E0B',
      'stroke-width': 2.5, 'stroke-dasharray': '10,5'
    }));
    zoneLabel(svg, ZX + 14, 577, 'EXTERNAL DEPENDENCY', '#D97706');

    // Endpoint box
    const ex = 70, ey = 591, ew = bw, eh = 165;
    svg.appendChild(s('rect', { x: ex, y: ey, width: ew, height: eh, rx: 10, fill: '#FEF3C7', stroke: '#F59E0B', 'stroke-width': 1.5 }));
    sectionText(svg, ex + ew/2, ey + 24, 'University Transport Endpoint', 14, '#92400E', 700).setAttribute('text-anchor', 'middle');
    const eSub = s('text', { x: ex + ew/2, y: ey + 44, 'text-anchor': 'middle', 'font-size': 10.5, fill: '#64748B' });
    eSub.textContent = 'Campus network or approved VPN access required';
    svg.appendChild(eSub);

    // HTTP endpoint chips
    const eMods = [
      { label: '/nptg/naptan.xml', tip: '<strong>/nptg/naptan.xml</strong><br>National Public Transport Access Node database (Lancashire). Contains stop/station locations, types, ATCO codes, and coordinates. ~17MB, rarely changes.' },
      { label: '/bus/live/{op}', tip: '<strong>/bus/live/{operator}</strong><br>Real-time GPS tracking data by National Operator Code (ARCT, BLAC, KLCO, SCCU, SCMY, NUTT). Updates every few seconds.' },
      { label: '/bus/times/{op}', tip: '<strong>/bus/times/{operator}</strong><br>Route and timetable information by operator. Includes links to timetable data files. Updated periodically.' },
      { label: '/rail/departures/{crs}', tip: '<strong>/rail/departures/{crs}</strong><br>Rail departure board data by 3-letter CRS code (e.g., LAN = Lancaster, PRE = Preston). Shows upcoming departures with live status.' },
      { label: '/weather', tip: '<strong>/weather?lat={lat}&amp;lon={lon}</strong><br>Current weather conditions for latitude/longitude. Data binned into geographic areas due to API rate limits. Updates every few minutes.' },
    ];
    const eChipW = 136, eGap = 12;
    const etcW = 50;
    const eLabelSpace = 65; // room for "HTTP:" / "STOMP:" labels on the left
    const eTotalW = eMods.length * eChipW + eMods.length * eGap + etcW;
    const eStartX = (ex + eLabelSpace) + ((ew - eLabelSpace) - eTotalW) / 2 + eChipW / 2;
    const eChipY = ey + 75;
    eMods.forEach((m, i) => {
      chip(svg, eStartX + i * (eChipW + eGap), eChipY, eChipW, chipH, m.label, '#FFFBEB', '#FCD34D', m.tip);
    });

    // "etc." chip â€” indicates more endpoints exist
    const etcCx = eStartX + (eMods.length - 1) * (eChipW + eGap) + eChipW / 2 + eGap + etcW / 2;
    chip(svg, etcCx, eChipY, etcW, chipH, 'etc.', '#FFF7ED', '#FDBA74', shortEtcTip);

    // STOMP topic chips
    const sMods = [
      { label: 'TRAIN_MVT_ALL_TOC', tip: '<strong>STOMP: TRAIN_MVT_ALL_TOC</strong><br>TRUST train movement feed. ~30 messages/min. Includes activation, movement, cancellation, reinstatement, and change messages for all Train Operating Companies.' },
      { label: 'VSTP_ALL', tip: '<strong>STOMP: VSTP_ALL</strong><br>Very Short-Term Planning feed. Timetable amendments within 48 hours of a train running: cancellations, additional services, route changes.' },
      { label: 'TD_ALL_SIG_AREA', tip: '<strong>STOMP: TD_ALL_SIG_AREA</strong><br>Train Describer feed. ~230 messages/min. C-Class berth movement and S-Class signalling state messages for detailed train tracking.' },
    ];
    const sChipW = 170, sGap = 20;
    const sTotalW = sMods.length * sChipW + (sMods.length - 1) * sGap;
    const sStartX = (ex + eLabelSpace) + ((ew - eLabelSpace) - sTotalW) / 2 + sChipW / 2;
    const sChipY = ey + 115;

    // STOMP label
    const stompLbl = s('text', { x: ex + 14, y: sChipY + 1, 'dominant-baseline': 'central', 'font-size': 10, 'font-weight': 600, fill: '#92400E' });
    stompLbl.textContent = 'STOMP:';
    svg.appendChild(stompLbl);

    sMods.forEach((m, i) => {
      chip(svg, sStartX + i * (sChipW + sGap), sChipY, sChipW, chipH, m.label, '#FEF9C3', '#FBBF24', m.tip);
    });

    // HTTP label
    const httpLbl = s('text', { x: ex + 14, y: eChipY + 1, 'dominant-baseline': 'central', 'font-size': 10, 'font-weight': 600, fill: '#92400E' });
    httpLbl.textContent = 'HTTP:';
    svg.appendChild(httpLbl);
  })();

  // ================================================================
  // DIAGRAM 2: DEPLOYMENT SCOPE
  // ================================================================
  (function renderDiagram2() {
    const svg = $('d2');
    const W = 1060, H = 380;
    svg.setAttribute('width', W);
    svg.setAttribute('height', H);
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    addDefs(svg);

    function deployBox(parent, cx, cy, w, h, label, sublabel, fill, stroke, tipHtml) {
      const g = s('g', { cursor: 'pointer' });
      g.appendChild(s('rect', { x: cx - w/2, y: cy - h/2, width: w, height: h, rx: 10, fill: fill, stroke: stroke, 'stroke-width': 1.5 }));
      const t = s('text', { x: cx, y: sublabel ? cy - 4 : cy + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 12, 'font-weight': 700, fill: '#0F172A' });
      t.textContent = label;
      g.appendChild(t);
      if (sublabel) {
        const st = s('text', { x: cx, y: cy + 14, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 9.5, fill: '#64748B' });
        st.textContent = sublabel;
        g.appendChild(st);
      }
      if (tipHtml) {
        g.addEventListener('mouseenter', e => showTip(e, tipHtml));
        g.addEventListener('mousemove', moveTip);
        g.addEventListener('mouseleave', hideTip);
      }
      parent.appendChild(g);
      return g;
    }

    function hArrow(parent, x1, x2, y, marker) {
      parent.appendChild(s('line', { x1: x1, y1: y, x2: x2, y2: y, stroke: '#64748B', 'stroke-width': 2, 'marker-end': marker || 'url(#ag)' }));
    }

    // Coursework app section background
    svg.appendChild(s('rect', { x: 20, y: 15, width: W - 40, height: 130, rx: 12, fill: '#F0FDF4', stroke: '#BBF7D0', 'stroke-width': 1 }));
    zoneLabel(svg, 34, 32, 'COURSEWORK APP DEPLOYMENT', '#16A34A');

    // Coursework app note
    const cwNote = s('text', { x: W - 50, y: 32, 'text-anchor': 'end', 'font-size': 10, fill: '#64748B', 'font-style': 'italic' });
    cwNote.textContent = 'Live endpoint access on campus network or approved VPN';
    svg.appendChild(cwNote);

    const cwY = 90;
    deployBox(svg, 170, cwY, 180, 56, 'User Browser', 'React PWA', '#DBEAFE', '#3B82F6',
      '<strong>User Browser</strong><br>React Progressive Web App running in the user\'s browser. Handles all UI rendering, local storage, and API calls to the backend.');
    hArrow(svg, 262, 368, cwY);
    deployBox(svg, 470, cwY, 200, 56, 'Frontend + Backend', 'Integration Layer', '#D1FAE5', '#10B981',
      '<strong>Frontend + Backend Integration Layer</strong><br>Single-server deployment running both the static frontend and the Express backend proxy. Serves the PWA assets and handles all API routing.');
    hArrow(svg, 572, 678, cwY);
    deployBox(svg, 790, cwY, 200, 56, 'University Endpoint', 'transport.scc.lancs.ac.uk', '#FEF3C7', '#F59E0B',
      '<strong>University Transport Endpoint</strong><br>External data source providing NaPTAN, bus, rail, weather feeds and STOMP real-time topics. Hosted on campus infrastructure.');

    // Production section background
    svg.appendChild(s('rect', { x: 20, y: 170, width: W - 40, height: 195, rx: 12, fill: '#F8FAFC', stroke: '#E2E8F0', 'stroke-width': 1 }));
    zoneLabel(svg, 34, 187, 'PRODUCTION ESTIMATE', '#64748B');

    const prodNote = s('text', { x: W - 50, y: 187, 'text-anchor': 'end', 'font-size': 10, fill: '#64748B', 'font-style': 'italic' });
    prodNote.textContent = 'Horizontally scalable architecture for ~200,000 MAU';
    svg.appendChild(prodNote);

    const prodY = 237;
    deployBox(svg, 110, prodY, 130, 52, 'Users', '', '#F1F5F9', '#94A3B8',
      '<strong>Users</strong><br>~200,000 monthly active users across the Preston-Lancaster-Blackpool-Fylde-Wyre region.');
    hArrow(svg, 177, 233, prodY);
    deployBox(svg, 300, prodY, 130, 52, 'CDN', 'Static Frontend', '#DBEAFE', '#3B82F6',
      '<strong>CDN / Static Frontend Hosting</strong><br>Frontend assets served via Content Delivery Network for low-latency global distribution. Handles all static file delivery.');
    hArrow(svg, 367, 423, prodY);
    deployBox(svg, 490, prodY, 130, 52, 'Load Balancer', '', '#E0E7FF', '#6366F1',
      '<strong>Load Balancer</strong><br>Distributes incoming API requests across multiple backend instances. Enables horizontal scaling without code changes.');
    hArrow(svg, 557, 613, prodY);
    deployBox(svg, 690, prodY, 150, 52, 'Backend Instances', 'Stateless (n)', '#D1FAE5', '#10B981',
      '<strong>Stateless Backend Instances</strong><br>Multiple Node.js/Express instances running in parallel. Each instance maintains its own in-memory cache. No shared state required for coursework app feature set.');

    // Branch to database (directly below Backend Instances)
    const dbX = 690, dbY = 325;
    svg.appendChild(s('line', { x1: dbX, y1: prodY + 28, x2: dbX, y2: dbY - 24, stroke: '#64748B', 'stroke-width': 1.5, 'stroke-dasharray': '5,3', 'marker-end': 'url(#ag)' }));
    deployBox(svg, dbX, dbY, 150, 44, 'Managed DB', 'Future only', '#FEF3C7', '#F59E0B',
      '<strong>Managed Database</strong><br>Optional production-only component for persistent data storage. Not required for the coursework app, which uses in-memory caching exclusively.');

    // Ext endpoint in production
    hArrow(svg, 767, 840, prodY);
    deployBox(svg, 930, prodY, 180, 52, 'External Data Feeds', 'Gov + Rail + Weather', '#FEF3C7', '#F59E0B',
      '<strong>External Data Feeds</strong><br>In production, data would be fetched from official government, rail operator, and weather APIs rather than the university proxy endpoint.');
  })();

  // ================================================================
  // DIAGRAM 3: LAYERED MODULE VIEW (COURSEWORK APP)
  // ================================================================
  (function renderDiagram3() {
    const svg = $('d3');
    const W = 1060, H = 915;
    svg.setAttribute('width', W);
    svg.setAttribute('height', H);
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    addDefs(svg);

    const LX = 30, LW = W - 60;

    // ---- LAYER 1: LOCAL DEVICE (encompasses both frontend and backend in coursework app) ----
    // Outer device rect
    svg.appendChild(s('rect', { x: LX, y: 15, width: LW, height: 655, rx: 14, fill: '#F8FAFC', stroke: '#CBD5E1', 'stroke-width': 1.5 }));
    zoneLabel(svg, LX + 14, 32, 'LOCAL DEVICE (COURSEWORK APP: everything runs locally)', '#64748B');

    // Browser rect
    svg.appendChild(s('rect', { x: LX + 20, y: 50, width: LW - 40, height: 278, rx: 10, fill: '#FFFFFF', stroke: '#94A3B8', 'stroke-width': 1 }));
    sectionText(svg, LX + 38, 70, 'BROWSER', 11, '#64748B', 600);

    // Frontend framework rect
    svg.appendChild(s('rect', { x: LX + 40, y: 82, width: LW - 80, height: 233, rx: 10, fill: '#EFF6FF', stroke: '#3B82F6', 'stroke-width': 1.5 }));
    sectionText(svg, W / 2, 104, 'FRONTEND (React + TypeScript)', 13, '#1D4ED8', 700).setAttribute('text-anchor', 'middle');

    const shortListTip = 'This is not the full list. This is a shortened version for the diagram.';

    // Module cards (2 rows of 3)
    const modules3 = [
      [
        { label: 'MapModule', sub: 'Leaflet + OSM tiles', tip: '<strong>MapModule</strong><br>Interactive Leaflet map with OpenStreetMap tiles. Renders bus stops, rail stations, live vehicle markers, and route overlays. Region-restricted to project area with zoom/pan boundaries.' },
        { label: 'SearchModule', sub: 'Text search + results', tip: '<strong>SearchModule</strong><br>Text input search for stops and stations. Results rendered on map with markers and in a selectable list panel. Queries the backend /api/stops/search endpoint.' },
        { label: 'DeparturesModule', sub: 'Departure boards', tip: '<strong>DeparturesModule</strong><br>Displays next 5+ departures for a selected stop/station. Shows scheduled times, live status, operator, platform (rail) or route number (bus). Auto-refreshes at configurable intervals.' },
      ],
      [
        { label: 'JourneyModule', sub: 'Route planning UI', tip: '<strong>JourneyModule</strong><br>Journey planning interface with origin, destination, and optional intermediate stops. Displays primary and alternative routes with step-by-step leg instructions and transfer points.' },
        { label: 'WeatherModule', sub: 'Advisories + conditions', tip: '<strong>WeatherModule</strong><br>Displays current weather for selected location. Derives transport-impact advisories from thresholds (wind speed, precipitation, temperature). Shown as prominent banner when thresholds are exceeded.' },
        { label: 'etc.', sub: 'Shortened list', tip: shortListTip },
      ]
    ];

    const cardW = 270, cardH = 72, cardGap = 30;
    const rowW = 3 * cardW + 2 * cardGap;
    const cardStartX = W / 2 - rowW / 2 + cardW / 2;

    modules3.forEach((row, ri) => {
      const rowY = 136 + ri * (cardH + 18);
      row.forEach((mod, ci) => {
        const cx = cardStartX + ci * (cardW + cardGap);
        const cy = rowY + cardH / 2;
        const g = s('g', { cursor: 'pointer' });
        const r = s('rect', { x: cx - cardW/2, y: cy - cardH/2, width: cardW, height: cardH, rx: 8, fill: '#FFFFFF', stroke: '#93C5FD', 'stroke-width': 1.5 });
        g.appendChild(r);
        const t1 = s('text', { x: cx, y: cy - 10, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 12.5, 'font-weight': 700, fill: '#1E40AF' });
        t1.textContent = mod.label;
        g.appendChild(t1);
        const t2 = s('text', { x: cx, y: cy + 10, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10, fill: '#64748B' });
        t2.textContent = mod.sub;
        g.appendChild(t2);
        g.addEventListener('mouseenter', e => {
          r.setAttribute('stroke-width', '2.5');
          r.setAttribute('stroke', '#3B82F6');
          r.setAttribute('filter', 'url(#ds)');
          showTip(e, mod.tip);
        });
        g.addEventListener('mousemove', moveTip);
        g.addEventListener('mouseleave', () => {
          r.setAttribute('stroke-width', '1.5');
          r.setAttribute('stroke', '#93C5FD');
          r.removeAttribute('filter');
          hideTip();
        });
        svg.appendChild(g);
      });
    });
    // ---- HTTPS REST API Arrow ----
    const apiArrowY1 = 350;
    const apiArrowY2 = 420;
    svg.appendChild(s('line', { x1: W/2, y1: apiArrowY1, x2: W/2, y2: apiArrowY2, stroke: '#64748B', 'stroke-width': 2.5, 'marker-end': 'url(#ag)' }));
    badge(svg, W/2, apiArrowY1 + (apiArrowY2 - apiArrowY1) * 0.38, 'HTTPS REST API', '#475569');

    // ---- LAYER 2: BACKEND ----
    svg.appendChild(s('rect', { x: LX + 20, y: 430, width: LW - 40, height: 210, rx: 14, fill: '#ECFDF5', stroke: '#10B981', 'stroke-width': 1.5 }));
    sectionText(svg, W/2, 455, 'BACKEND (Node.js + Express + TypeScript)', 13, '#047857', 700).setAttribute('text-anchor', 'middle');

    const bModules3 = [
      { label: 'ApiRoutes', sub: 'Express handlers', tip: '<strong>ApiRoutes</strong><br>Express HTTP route handlers with request validation, error formatting, and consistent JSON response envelope. Defines endpoints: /api/stops/search, /api/departures/{atcoCode}, /api/bus/live/{operator}, /api/journey/plan, /api/weather.' },
      { label: 'DataIngestion', sub: 'Feed fetch + parse', tip: '<strong>DataIngestion</strong><br>Fetches and parses data from university transport endpoints. Handles NaPTAN XML, bus live XML, bus times JSON (with linked timetable XML), rail departures, and weather JSON. Manages request timeouts and retry logic.' },
      { label: 'CacheService', sub: 'node-cache TTL', tip: '<strong>CacheService</strong><br>In-memory cache using node-cache library with TTL expiry per entity type:<br>Stops/timetables: 24h<br>Bus positions: 30s<br>Rail departures: 60s<br>Weather: 5min' },
      { label: 'JourneyEngine', sub: 'Route calculation', tip: '<strong>JourneyEngine</strong><br>Modified Dijkstra route calculation with weighted cost for travel time, waiting time, transfer penalty, and hub preference. Generates primary route plus alternatives by penalising previously selected edges.' },
      { label: 'StompClient', sub: 'Real-time rail', tip: '<strong>StompClient</strong><br>Persistent STOMP connection to transport.scc.lancs.ac.uk:61613. Subscribes to TRAIN_MVT_ALL_TOC, VSTP_ALL, TD_ALL_SIG_AREA. Auto-reconnects with exponential backoff (1s, 2s, 4s, max 30s).' },
      { label: 'etc.', sub: 'Shortened list', tip: shortListTip },
    ];

    const bCardW = 210, bCardH = 65, bGap = 25, bRowGap = 15;
    const bColsPerRow = 3;
    const bRowW = bColsPerRow * bCardW + (bColsPerRow - 1) * bGap;
    const bStartX = W/2 - bRowW/2 + bCardW/2;
    const bRowY = 475;

    bModules3.forEach((mod, i) => {
      const row = Math.floor(i / bColsPerRow);
      const col = i % bColsPerRow;
      const cx = bStartX + col * (bCardW + bGap);
      const cy = bRowY + row * (bCardH + bRowGap) + bCardH/2;
      const g = s('g', { cursor: 'pointer' });
      const r = s('rect', { x: cx - bCardW/2, y: cy - bCardH/2, width: bCardW, height: bCardH, rx: 8, fill: '#FFFFFF', stroke: '#6EE7B7', 'stroke-width': 1.5 });
      g.appendChild(r);
      const t1 = s('text', { x: cx, y: cy - 9, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 11.5, 'font-weight': 700, fill: '#065F46' });
      t1.textContent = mod.label;
      g.appendChild(t1);
      const t2 = s('text', { x: cx, y: cy + 9, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 9.5, fill: '#64748B' });
      t2.textContent = mod.sub;
      g.appendChild(t2);
      g.addEventListener('mouseenter', e => {
        r.setAttribute('stroke-width', '2.5');
        r.setAttribute('stroke', '#10B981');
        r.setAttribute('filter', 'url(#ds)');
        showTip(e, mod.tip);
      });
      g.addEventListener('mousemove', moveTip);
      g.addEventListener('mouseleave', () => {
        r.setAttribute('stroke-width', '1.5');
        r.setAttribute('stroke', '#6EE7B7');
        r.removeAttribute('filter');
        hideTip();
      });
      svg.appendChild(g);
    });
    // ---- HTTPS + STOMP Arrow ----
    const stompArrowY1 = 680;
    const stompArrowY2 = 755;
    svg.appendChild(s('line', { x1: W/2, y1: stompArrowY1, x2: W/2, y2: stompArrowY2, stroke: '#64748B', 'stroke-width': 2.5, 'marker-end': 'url(#ag)' }));
    badge(svg, W/2, stompArrowY1 + (stompArrowY2 - stompArrowY1) * 0.38, 'HTTPS + STOMP (campus/VPN)', '#64748B');

    // ---- LAYER 3: EXTERNAL ----
    svg.appendChild(s('rect', { x: LX, y: 765, width: LW, height: 130, rx: 14, fill: '#FFFBEB', stroke: '#F59E0B', 'stroke-width': 1.5 }));
    sectionText(svg, W/2, 791, 'UNIVERSITY TRANSPORT ENDPOINT (External Dependency)', 13, '#92400E', 700).setAttribute('text-anchor', 'middle');

    // Endpoint chips in a single row
    const extChips = [
      { label: 'naptan.xml', tip: '<strong>/nptg/naptan.xml</strong><br>NaPTAN database for Lancashire. Stop locations, types, ATCO codes, coordinates. ~17MB.' },
      { label: 'bus/live/{op}', tip: '<strong>/bus/live/{operator}</strong><br>Real-time GPS tracking by operator code. Updates every few seconds.' },
      { label: 'rail/departures/{crs}', tip: '<strong>/rail/departures/{crs}</strong><br>Rail departure board by CRS station code.' },
      { label: 'STOMP topics', tip: '<strong>STOMP Real-Time Feeds</strong><br>TRAIN_MVT_ALL_TOC: Train movements (~30 msg/min)<br>VSTP_ALL: Short-term timetable changes<br>TD_ALL_SIG_AREA: Train describer signals (~230 msg/min)' },
      { label: 'etc.', tip: shortListTip },
    ];
    const extCW = 140, extGap = 18;
    const extTotalW = extChips.length * extCW + (extChips.length - 1) * extGap;
    const extStartX = W/2 - extTotalW/2 + extCW/2;
    extChips.forEach((ec, i) => {
      chip(svg, extStartX + i * (extCW + extGap), 830, extCW, 28, ec.label, '#FEF9C3', '#FBBF24', ec.tip);
    });
  })();

  // ================================================================
  // DIAGRAM 4: DATA FLOW SEQUENCE (SEARCH REQUEST)
  // ================================================================
  (function renderDiagram4() {
    const svg = $('d4');
    const W = 1000, H = 580;
    svg.setAttribute('width', W);
    svg.setAttribute('height', H);
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    addDefs(svg);

    const actors = [
      { x: 160, label: 'User / Browser', color: '#3B82F6', fill: '#DBEAFE' },
      { x: 500, label: 'Backend API', color: '#10B981', fill: '#D1FAE5' },
      { x: 840, label: 'University Endpoint', color: '#F59E0B', fill: '#FEF3C7' },
    ];

    // Actor header boxes
    actors.forEach(a => {
      svg.appendChild(s('rect', { x: a.x - 90, y: 15, width: 180, height: 42, rx: 10, fill: a.fill, stroke: a.color, 'stroke-width': 2 }));
      const t = s('text', { x: a.x, y: 37, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 13, 'font-weight': 700, fill: '#0F172A' });
      t.textContent = a.label;
      svg.appendChild(t);
    });

    // Lifelines
    const lifeTop = 60, lifeBot = H - 20;
    actors.forEach(a => {
      svg.appendChild(s('line', { x1: a.x, y1: lifeTop, x2: a.x, y2: lifeBot, stroke: '#CBD5E1', 'stroke-width': 1.5, 'stroke-dasharray': '6,4' }));
    });

    // Sequence steps
    const steps = [
      {
        type: 'msg', from: 0, to: 1, y: 100, label: 'GET /api/stops/search?q=lancaster',
        tip: '<strong>Step 1: Search Request</strong><br>User types a search query. The frontend sends an HTTP GET request to the backend API with the search term as a query parameter.'
      },
      {
        type: 'self', actor: 1, y: 155, label: 'Check in-memory cache',
        tip: '<strong>Step 2: Cache Lookup</strong><br>Backend checks node-cache for a valid (non-expired) cached response matching this query. Cache TTL for stop data is 24 hours.'
      },
      {
        type: 'note', actor: 1, y: 205, label: 'Cache hit?',
        tip: '<strong>Step 3: Cache Decision</strong><br>If a valid cached entry exists, skip directly to returning the response. If cache miss, proceed to fetch from the university endpoint.'
      },
      {
        type: 'msg', from: 1, to: 2, y: 260, label: '[miss] Fetch NaPTAN/NPTG data', dashed: true,
        tip: '<strong>Step 4: Upstream Fetch</strong><br>On cache miss, the backend fetches NaPTAN/NPTG data from the university endpoint. Request includes timeout handling and retry with exponential backoff (up to 3 attempts).'
      },
      {
        type: 'msg', from: 2, to: 1, y: 310, label: 'Raw XML / JSON response', dashed: true,
        tip: '<strong>Step 5: Raw Response</strong><br>University endpoint returns the raw data payload. For NaPTAN this is XML (~17MB for Lancashire); for other feeds it may be JSON.'
      },
      {
        type: 'note', actor: 1, y: 365, label: 'Validate + filter by region + normalize',
        tip: '<strong>Step 6: Normalization Pipeline</strong><br>Backend validates required fields, filters records to the project geography (Preston-Lancaster-Blackpool-Fylde-Wyre), drops malformed entries with logging, and normalizes remaining records to internal schema.'
      },
      {
        type: 'note', actor: 1, y: 405, label: 'Store in cache with TTL',
        tip: '<strong>Step 7: Cache Storage</strong><br>Normalized results are stored in the in-memory cache with the appropriate TTL (24 hours for stop/station data). Subsequent identical queries will be served from cache.'
      },
      {
        type: 'msg', from: 1, to: 0, y: 455, label: 'JSON response (filtered, normalized)',
        tip: '<strong>Step 8: API Response</strong><br>Backend returns the normalized results as a consistent JSON response. Includes stop names, types, coordinates, and ATCO codes. Response must arrive within 2 seconds (NFR2.1).'
      },
      {
        type: 'note', actor: 0, y: 510, label: 'Render search results + map markers',
        tip: '<strong>Step 9: UI Rendering</strong><br>Frontend receives the JSON response, displays results in a list panel, and places markers on the Leaflet map. User can click a result to navigate to the stop/station detail page.'
      },
    ];

    // Step number counter
    let stepNum = 0;

    steps.forEach(step => {
      stepNum++;
      const g = s('g', { cursor: 'pointer' });

      if (step.type === 'msg') {
        // Horizontal message arrow
        const fromX = actors[step.from].x;
        const toX = actors[step.to].x;
        const dir = toX > fromX ? 1 : -1;
        const x1 = fromX + dir * 8;
        const x2 = toX - dir * 12;

        const line = s('line', {
          x1: x1, y1: step.y, x2: x2, y2: step.y,
          stroke: '#475569', 'stroke-width': 2, 'marker-end': 'url(#as)'
        });
        if (step.dashed) line.setAttribute('stroke-dasharray', '8,4');
        g.appendChild(line);

        // Label above arrow
        const midX = (x1 + x2) / 2;
        const lbl = s('text', { x: midX, y: step.y - 10, 'text-anchor': 'middle', 'font-size': 10.5, 'font-weight': 600, fill: '#334155' });
        lbl.textContent = step.label;
        g.appendChild(lbl);

        // Step number circle
        const cx = dir > 0 ? fromX - 28 : fromX + 28;
        g.appendChild(s('circle', { cx: cx, cy: step.y, r: 12, fill: '#475569' }));
        const nt = s('text', { x: cx, y: step.y + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10, 'font-weight': 700, fill: '#FFFFFF' });
        nt.textContent = stepNum;
        g.appendChild(nt);
      }

      if (step.type === 'self') {
        // Self-call loop
        const ax = actors[step.actor].x;
        const loopW = 40, loopH = 30;
        const path = s('path', {
          d: `M ${ax + 4} ${step.y - loopH/2} L ${ax + loopW} ${step.y - loopH/2} L ${ax + loopW} ${step.y + loopH/2} L ${ax + 4} ${step.y + loopH/2}`,
          fill: 'none', stroke: '#475569', 'stroke-width': 1.8, 'marker-end': 'url(#as)'
        });
        g.appendChild(path);

        // Label
        const lbl = s('text', { x: ax + loopW + 10, y: step.y + 1, 'dominant-baseline': 'central', 'font-size': 10.5, 'font-weight': 600, fill: '#334155' });
        lbl.textContent = step.label;
        g.appendChild(lbl);

        // Step number
        g.appendChild(s('circle', { cx: ax - 28, cy: step.y, r: 12, fill: '#475569' }));
        const nt = s('text', { x: ax - 28, y: step.y + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10, 'font-weight': 700, fill: '#FFFFFF' });
        nt.textContent = stepNum;
        g.appendChild(nt);
      }

      if (step.type === 'note') {
        // Note box on lifeline
        const ax = actors[step.actor].x;
        const noteW = step.label.length * 6.5 + 24;
        const noteH = 26;
        g.appendChild(s('rect', {
          x: ax - noteW/2, y: step.y - noteH/2, width: noteW, height: noteH,
          rx: 6, fill: '#F1F5F9', stroke: '#CBD5E1', 'stroke-width': 1
        }));
        const lbl = s('text', { x: ax, y: step.y + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10.5, fill: '#475569', 'font-weight': 500 });
        lbl.textContent = step.label;
        g.appendChild(lbl);

        // Step number
        const numX = step.actor === 0 ? ax - noteW/2 - 22 : ax - noteW/2 - 22;
        g.appendChild(s('circle', { cx: numX, cy: step.y, r: 12, fill: '#475569' }));
        const nt = s('text', { x: numX, y: step.y + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 10, 'font-weight': 700, fill: '#FFFFFF' });
        nt.textContent = stepNum;
        g.appendChild(nt);
      }

      // Tooltip interaction
      g.addEventListener('mouseenter', e => {
        g.style.opacity = '1';
        showTip(e, step.tip);
      });
      g.addEventListener('mousemove', moveTip);
      g.addEventListener('mouseleave', () => {
        hideTip();
      });

      svg.appendChild(g);
    });
  })();

  // ================================================================
  // DIAGRAM 5: DATA NORMALIZATION PIPELINE
  // ================================================================
  (function renderDiagram5() {
    const svg = $('d5');
    const W = 1060, H = 250;
    svg.setAttribute('width', W);
    svg.setAttribute('height', H);
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    addDefs(svg);

    const stages = [
      { label: 'Raw Feed', color: '#F59E0B', fill: '#FEF3C7', stroke: '#F59E0B',
        tip: '<strong>Raw Feed</strong><br>Incoming data payload from one of the university transport endpoints: NaPTAN XML, bus live XML, bus times JSON (with linked timetable XML), rail departures, or weather JSON. Format and schema varies by feed.' },
      { label: 'Parse', color: '#FB923C', fill: '#FFF7ED', stroke: '#FB923C',
        tip: '<strong>Parse</strong><br>Extract structured data from the raw payload. XML feeds are parsed to DOM then traversed; JSON feeds are deserialized. Field extraction handles format variations between operators.' },
      { label: 'Validate', color: '#EAB308', fill: '#FEFCE8', stroke: '#EAB308',
        tip: '<strong>Validate</strong><br>Check each record for required fields per entity schema (e.g., TransportStop must have atcoCode, name, type, coordinates). Records missing required fields are rejected and counted.' },
      { label: 'Normalize', color: '#22C55E', fill: '#F0FDF4', stroke: '#22C55E',
        tip: '<strong>Normalize</strong><br>Convert remaining records to the internal schema (TransportStop, LiveVehicle, Departure, WeatherData). Standardizes field names, formats, and types across different source feeds.' },
      { label: 'Cache', color: '#10B981', fill: '#ECFDF5', stroke: '#10B981',
        tip: '<strong>Cache</strong><br>Store normalized records in node-cache with entity-specific TTL. Stops: 24h, Bus positions: 30s, Rail departures: 60s, Weather: 5min. Expired entries trigger fresh upstream fetch.' },
      { label: 'API Response', color: '#3B82F6', fill: '#EFF6FF', stroke: '#3B82F6',
        tip: '<strong>API Response</strong><br>Normalized, cached data served to the frontend via REST API endpoints. Consistent JSON format regardless of original feed source. Response within 2 seconds under average load.' },
    ];

    const stageW = 110, stageH = 48, gap = 32;
    const totalW = stages.length * stageW + (stages.length - 1) * gap;
    const startX = W/2 - totalW/2 + stageW/2;
    const mainY = 65;

    // Main pipeline stages
    stages.forEach((st, i) => {
      const cx = startX + i * (stageW + gap);
      const g = s('g', { cursor: 'pointer' });

      // Box
      const r = s('rect', { x: cx - stageW/2, y: mainY - stageH/2, width: stageW, height: stageH, rx: 10, fill: st.fill, stroke: st.stroke, 'stroke-width': 2 });
      g.appendChild(r);

      // Label
      const t = s('text', { x: cx, y: mainY + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 12, 'font-weight': 700, fill: '#0F172A' });
      t.textContent = st.label;
      g.appendChild(t);

      // Stage number
      g.appendChild(s('circle', { cx: cx - stageW/2 + 2, cy: mainY - stageH/2 + 2, r: 10, fill: st.color }));
      const nt = s('text', { x: cx - stageW/2 + 2, y: mainY - stageH/2 + 3, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 9, 'font-weight': 700, fill: '#FFFFFF' });
      nt.textContent = i + 1;
      g.appendChild(nt);

      g.addEventListener('mouseenter', e => {
        r.setAttribute('stroke-width', '3');
        r.setAttribute('filter', 'url(#ds)');
        showTip(e, st.tip);
      });
      g.addEventListener('mousemove', moveTip);
      g.addEventListener('mouseleave', () => {
        r.setAttribute('stroke-width', '2');
        r.removeAttribute('filter');
        hideTip();
      });
      svg.appendChild(g);

      // Arrow to next stage
      if (i < stages.length - 1) {
        const ax1 = cx + stageW/2 + 2;
        const ax2 = cx + stageW/2 + gap - 2;
        svg.appendChild(s('line', { x1: ax1, y1: mainY, x2: ax2, y2: mainY, stroke: '#64748B', 'stroke-width': 2, 'marker-end': 'url(#ags)' }));
      }
    });

    // ---- Reject/Log branch ----
    // Branches down from Validate (index 2)
    const rejectY = 170;
    const rejectBoxW = 200, rejectBoxH = 44;
    const valCx = startX + 2 * (stageW + gap);

    // Reject box
    const rCx = valCx;
    const rG = s('g', { cursor: 'pointer' });
    rG.appendChild(s('rect', { x: rCx - rejectBoxW/2, y: rejectY - rejectBoxH/2, width: rejectBoxW, height: rejectBoxH, rx: 10, fill: '#FEF2F2', stroke: '#EF4444', 'stroke-width': 2 }));
    const rT = s('text', { x: rCx, y: rejectY + 1, 'text-anchor': 'middle', 'dominant-baseline': 'central', 'font-size': 12, 'font-weight': 700, fill: '#991B1B' });
    rT.textContent = 'Reject + Log';
    rG.appendChild(rT);

    const rTip = '<strong>Reject + Log</strong><br>Records that fail validation (missing required fields) are dropped from the pipeline. Rejection counts are logged per feed for monitoring data quality and upstream schema changes.';
    rG.addEventListener('mouseenter', e => showTip(e, rTip));
    rG.addEventListener('mousemove', moveTip);
    rG.addEventListener('mouseleave', hideTip);
    svg.appendChild(rG);

    // Arrow from Validate down to reject
    const rejectTop = rejectY - rejectBoxH / 2;
    svg.appendChild(s('line', {
      x1: valCx, y1: mainY + stageH/2 + 2, x2: valCx, y2: rejectTop - 2,
      stroke: '#EF4444', 'stroke-width': 1.8, 'stroke-dasharray': '5,3', 'marker-end': 'url(#ar)'
    }));

    // Reject labels on arrows
    const vLbl = s('text', { x: valCx - 6, y: mainY + stageH/2 + 20, 'text-anchor': 'end', 'font-size': 9, fill: '#EF4444', 'font-weight': 600 });
    vLbl.textContent = 'invalid';
    svg.appendChild(vLbl);

    // Description text below
    const descY = 225;
    const desc = s('text', { x: W/2, y: descY, 'text-anchor': 'middle', 'font-size': 11, fill: '#64748B' });
    desc.textContent = 'Every external payload passes through this pipeline before reaching the frontend. Malformed records are rejected and logged.';
    svg.appendChild(desc);
  })();

})();
</script>
</body>
</html>
